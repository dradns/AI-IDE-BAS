### 4.5. مخطط نشاط عملية العمل بتنسيق PlantUML (مخطط النشاط)
**تعليمات لإنشاء مخططات النشاط لعامل الذكاء الاصطناعي**

#### 4.5.1. المحتويات
1. [الأساسيات والمتطلبات](#الأساسيات-والمتطلبات)
2. [هيكل المخطط](#هيكل-المخطط)
3. [مقاييس الجودة](#مقاييس-الجودة)
4. [قواعد التحقق](#قواعد-التحقق)
5. [النموذج الأساسي](#النموذج-الأساسي)
6. [عناصر المخطط](#عناصر-المخطط)
7. [التركيبات التحكمية](#التركيبات-التحكمية)
8. [معالجة التزامن](#معالجة-التزامن)
9. [التكامل مع القطع الأثرية](#التكامل-مع-القطع-الأثرية)
10. [أنماط قياسية](#أنماط-قياسية)
11. [قائمة التحقق من الجودة](#قائمة-التحقق-من-الجودة)

---

#### 4.5.2. الأساسيات والمتطلبات

##### 4.5.2.1. القطع الأثرية المدخلة الإلزامية:
- **User Story** - لفهم الهدف التجاري وحدود العملية
- **Use Case** - للحصول على وصف مفصل لتدفق الإجراءات
- **Business Process Description** - لفهم المنطق والقواعد

##### 4.5.2.2. قطع أثرية إضافية:
- المواصفات الفنية، Business Rules، توثيق Workflow
- مخططات التسلسل لفهم التفاعلات

##### 4.5.2.3. الغرض من مخطط النشاط:
- نمذجة تدفق الإجراءات واتخاذ القرارات
- تصور العمليات المتوازية والمزامنة
- توضيح منطق عملية العمل من البداية إلى النهاية
- تحديد نقاط اتخاذ القرار والمسارات البديلة

---

#### 4.5.3. هيكل المخطط

##### 4.5.3.1. العنوان والإعدادات
plantuml
@startuml
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 10
skinparam backgroundColor #FFFFFF

title اسم العملية من User Story


##### 4.5.3.2. Swimlanes (مسارات المسؤولية)
plantuml
|الدور 1|
start
:الإجراء 1;

|الدور 2|
:الإجراء 2;

|النظام|
:إجراء تلقائي;


##### 4.5.3.3. التنظيم الهيكلي
- **البداية**: نقطة البداية الإلزامية
- **الإجراءات**: وصف الخطوات المحددة
- **القرارات**: نقاط تفرع المنطق
- **التزامن**: fork/join للإجراءات المتزامنة
- **الإكمال**: end أو stop

---

#### 4.5.4. مقاييس الجودة

##### 4.5.4.1. المؤشرات المستهدفة:
- **تغطية التدفق**: تم تمثيل 100% من الخطوات من Use Case
- **التجميع المنطقي**: استخدام swimlanes للأدوار
- **تفصيل القرارات**: كل شرط 'if' له جميع النتائج الممكنة
- **التزامن**: تم تحديد ونمذجة العمليات المتزامنة
- **معالجة الأخطاء**: حد أدنى 2 من تدفقات معالجة الأخطاء

##### 4.5.4.2. نظام التقييم:
- **جودة ممتازة**: ≥90% امتثال للمقاييس + تغطية كاملة لـ Use Case
- **جودة جيدة**: 70-89% امتثال للمقاييس
- **بحاجة إلى تحسين**: <70% امتثال للمقاييس

##### 4.5.4.3. مقاييس محددة:
- عدد swimlanes: 2-6 (حسب الأدوار من Use Case)
- عدد القرارات: 1-5 لكل 10 إجراءات
- عمق التداخل: لا يزيد عن 3 مستويات
- التدفقات المتوازية: تم تحديد جميع العمليات المتوازية الممكنة

---

#### 4.5.5. قواعد التحقق

##### 4.5.5.1. الفحوصات التلقائية:

✓ يبدأ بـ @startuml، وينتهي بـ @enduml
✓ لديه نقطة بداية واحدة
✓ جميع المسارات تؤدي إلى end/stop
✓ كل شرط 'if' له فروع then/else مقابلة
✓ جميع عمليات fork لها عمليات join مقابلة
✓ الـ Swimlanes تتوافق مع الأدوار من Use Case
✓ الإجراءات تحتوي على أفعال نشطة
✓ لا توجد إجراءات "معلقة" بدون مدخلات/مخرجات
✓ تمت صياغة القرارات في شكل أسئلة


##### 4.5.5.2. الفحوصات الدلالية:

✓ كل إجراء يتوافق مع خطوة من Use Case
✓ تسلسل الإجراءات مترابط منطقياً
✓ الأدوار في swimlanes تتوافق مع الجهات الفاعلة من User Story
✓ جميع التدفقات البديلة من Use Case ممثلة
✓ تغطي معالجة الأخطاء الاستثناءات الرئيسية


---

#### 4.5.6. النموذج الأساسي

plantuml
@startuml
skinparam defaultFontName "Segoe UI"
skinparam defaultFontSize 10
skinparam backgroundColor #FFFFFF

title [اسم العملية من User Story]

|[الدور من User Story]|
start
:[الإجراء الأولي];

if ([شرط القرار]?) then (yes)
  :[الإجراء عند نتيجة إيجابية];
else (no)
  :[الإجراء عند نتيجة سلبية];
  stop
endif

|[النظام/دور آخر]|
:[إجراء تلقائي أو مفوض];

|[الدور من User Story]|
:[الإجراء النهائي];
end

@enduml


---

#### 4.5.7. عناصر المخطط

##### 4.5.7.1. العناصر الأساسية:

###### 4.5.7.1.1. البداية والنهاية
plantuml
start                    // نقطة الدخول الوحيدة
end                      // الإكمال الطبيعي
stop                     // الإنهاء الطارئ
kill                     // الإنهاء القسري
detach                   // الإنهاء غير المتزامن


###### 4.5.7.1.2. الأنشطة (Activities)
plantuml
:إجراء بفعل نشط;
:التحقق من صحة البيانات;
:إرسال إشعار;
:[إجراء بين قوسين معقوفين للنظام];


**قواعد تسمية الأنشطة:**
- البدء بفعل نشط في صيغة المصدر
- كن محدداً وقابلاً للقياس
- تجنب التفاصيل التقنية، ركز على منطق الأعمال
- الطول: 2-6 كلمات

###### 4.5.7.1.3. نقاط القرار (Decision Points)
plantuml
if (البيانات صحيحة؟) then (yes)
  :متابعة المعالجة;
else (no)
  :إرجاع خطأ في التحقق;
  stop
endif

// خيارات متعددة
switch (نوع المستخدم؟)
case (Admin)
  :عرض لوحة المشرف;
case (User)
  :عرض واجهة المستخدم;
case (Guest)
  :عرض صفحة الزائر;
endswitch


###### 4.5.7.1.4. المعالجة المتوازية
plantuml
fork
  :إرسال بريد إلكتروني;
fork again
  :إرسال رسالة نصية;
fork again
  :الكتابة في سجل التدقيق;
end fork

// مع المزامنة
fork
  :معالجة الدفع;
fork again
  :حجز المنتج;
end merge  // انتظار اكتمال جميع الفروع


###### 4.5.7.1.5. الحلقات والتكرار
plantuml
// حلقة بسيطة
repeat
  :الحصول على العنصر التالي;
  :معالجة العنصر;
repeat while (هل توجد المزيد من العناصر؟)

// حلقة while
while (شرط الاستمرار؟)
  :تنفيذ الإجراء;
endwhile

// حلقة for
repeat :i = 1;
  :معالجة العنصر i;
  :i = i + 1;
repeat while (i <= العدد؟)


---

#### 4.5.8. التركيبات التحكمية

##### 4.5.8.1. التفرع البسيط
plantuml
if (هل تم مصادقة المستخدم؟) then (yes)
  :عرض البيانات الشخصية;
else (no)
  :إعادة التوجيه إلى صفحة تسجيل الدخول;
  stop
endif


##### 4.5.8.2. التفرع المتعدد
plantuml
switch (حالة الطلب؟)
case (جديد)
  :إرسال للمعالجة;
case (قيد المعالجة)
  :متابعة المعالجة;
case (مكتمل)
  :إرسال إلى العميل;
case (ملغي)
  :استرداد المبلغ;
  stop
endswitch


##### 4.5.8.3. الشروط المتداخلة
plantuml
if (هل تم مصادقة المستخدم؟) then (yes)
  if (هل لديه صلاحيات المشرف؟) then (yes)
    :عرض وظائف المشرف;
  else (no)
    :عرض الواجهة العادية;
  endif
else (no)
  :عرض نموذج تسجيل الدخول;
endif


##### 4.5.8.4. معالجة الاستثناءات
plantuml
:محاولة تنفيذ العملية;
note right: قد يحدث خطأ

if (هل العملية ناجحة؟) then (yes)
  :متابعة التنفيذ;
else (no)
  if (هل الخطأ حرج؟) then (yes)
    :تسجيل الخطأ;
    :إشعار المسؤول;
    stop
  else (no)
    :عرض رسالة للمستخدم;
    :اقتراح إعادة المحاولة;
  endif
endif


---

#### 4.5.9. معالجة التزامن

##### 4.5.9.1. العمليات المتوازية المستقلة
plantuml
fork
  :إرسال إشعار بالبريد الإلكتروني;
fork again
  :إرسال إشعار push;
fork again
  :الكتابة في سجل التدقيق;
end fork

:متابعة العملية الرئيسية;


##### 4.5.9.2. العمليات المتزامنة
plantuml
fork
  :التحقق من توفر المنتج;
fork again
  :التحقق من الحد الائتماني;
fork again
  :التحقق من عنوان التسليم;
end merge

if (هل اجتازت جميع الفحوصات؟) then (yes)
  :إنشاء طلب;
else (no)
  :رفض الطلب;
  stop
endif


##### 4.5.9.3. التزامن الشرطي
plantuml
if (هل التوصيل السريع مطلوب؟) then (yes)
  fork
    :حجز المنتج;
  fork again
    :البحث عن أقرب مستودع;
  fork again
    :تحضير курьер;
  end merge
else (no)
  :المعالجة القياسية للطلب;
endif


---

#### 4.5.10. التكامل مع القطع الأثرية

##### 4.5.10.1. الارتباط مع User Story:
- **الأدوار في swimlanes** = الأدوار من "As a [role]"
- **التدفق الرئيسي** = تنفيذ "I want to [action]"
- **نتيجة المخطط** = تحقيق "So that [benefit]"

##### 4.5.10.2. الارتباط مع Use Case:
- **التدفق الرئيسي لـ UC** = التسلسل الرئيسي للإجراءات
- **التدفقات البديلة لـ UC** = فروع else/case
- **استثناءات UC** = كتل معالجة الأخطاء
- **شروط UC المسبقة** = الشروط في بداية المخطط
- **شروط UC اللاحقة** = الحالات في نقاط النهاية

##### 4.5.10.3. الارتباط مع Business Rules:
- **قواعد اتخاذ القرار** = الشروط في if/switch
- **قيود الأعمال** = كتل التحقق
- **عمليات الموافقة** = تسلسلات في swimlanes المقابلة

##### 4.5.10.4. الارتباط مع القطع الأثرية التقنية:
- **مواصفات API** = الإجراءات الآلية
- **مخطط قاعدة البيانات** = إجراءات استمرارية البيانات
- **مخططات التسلسل** = تفصيل التفاعلات بين swimlanes

---

#### 4.5.11. الأنماط القياسية

##### 4.5.11.1. نمط "الطلب-المعالجة-الاستجابة"
plantuml
|المستخدم|
start
:إرسال طلب;

|النظام|
:استلام الطلب;
:التحقق من البيانات;

if (البيانات صالحة؟) then (yes)
  :معالجة الطلب;
  :تكوين الاستجابة;
else (no)
  :تكوين خطأ;
endif

|المستخدم|
:استلام الاستجابة;
end


##### 4.5.11.2. نمط "سير عمل الموافقة"
plantuml
|المبادر|
start
:إنشاء طلب;

|المدير|
:مراجعة الطلب;

if (الموافقة؟) then (yes)
  if (المبلغ > الحد؟) then (yes)
    |المدير التنفيذي|
    :الموافقة النهائية;
    
    if (الموافقة؟) then (yes)
      |النظام|
      :تنفيذ العملية;
    else (no)
      :الرفض;
      stop
    endif
  else (no)
    |النظام|
    :تنفيذ العملية;
  endif
else (no)
  :الرفض;
  stop
endif

|المبادر|
:استلام الإشعار;
end


##### 4.5.11.3. نمط "المعالجة الدفعية"
plantuml
|النظام|
start
:الحصول على قائمة العناصر;

repeat
  :أخذ العنصر التالي;
  
  fork
    :معالجة العنصر;
  fork again
    :تسجيل التقدم;
  end fork
  
repeat while (هل توجد عناصر غير معالجة؟)

:توليد التقرير;
:إرسال إشعار الإكمال;
end


##### 4.5.11.4. نمط "استعادة الخطأ"
plantuml
|النظام|
start
:retry_count = 0;

repeat
  :محاولة تنفيذ العملية;
  
  if (العملية ناجحة؟) then (yes)
    :تسجيل النتيجة;
    end
  else (no)
    :retry_count++;
    
    if (retry_count < max_retries؟) then (yes)
      :انتظار الفاصل;
    else (no)
      :تسجيل خطأ حرج;
      :إشعار المسؤول;
      stop
    endif
  endif
repeat while (retry_count < max_retries؟)


---

#### 4.5.12. Swimlanes والأدوار

##### 4.5.12.1. قواعد استخدام swimlanes:
1. **swimlane واحدة = دور/نظام واحد**
2. **الحد الأقصى 6 swimlanes** (للسهولة القراءة)
3. **الأدوار مأخوذة من User Story و Use Case**
4. **يتم فصل الأنظمة عن الأدوار البشرية**

##### 4.5.12.2. swimlanes القياسية:
plantuml
|المستخدم|        // الدور الرئيسي من User Story
|النظام|             // العمليات الآلية
|المسؤول|       // إجراءات الإدارة
|النظام الخارجي|     // التكاملات
|قاعدة البيانات|         // فقط للعمليات المعقدة


##### 4.5.12.3. الانتقالات بين swimlanes:
- نقل التحكم = الانتقال إلى إجراء في swimlane أخرى
- العمل المتوازي = fork مع إجراءات في swimlanes مختلفة
- المزامنة = دمج الإجراءات من swimlanes مختلفة

---

#### 4.5.13. الأخطاء الشائعة وكيفية تجنبها

##### 4.5.13.1. التفاصيل التقنية المفرطة
❌ **غير صحيح:**
plantuml
:تنفيذ استعلام SQL SELECT على جدول users;
:فك ترميز استجابة JSON;
:تحديث Redux store;


✅ **صحيح:**
plantuml
:الحصول على بيانات المستخدم;
:معالجة المعلومات المستلمة;
:تحديث العرض;


##### 4.5.13.2. خلط مستويات التجريد
❌ **غير صحيح:**
plantuml
:النقر على زر "إرسال";
:التحقق من صحة عنوان البريد الإلكتروني;
:إرسال طلب HTTP POST;
:عرض رسالة النجاح;


✅ **صحيح:**
plantuml
:بدء إرسال النموذج;
:التحقق من صحة البيانات;
:نقل البيانات إلى النظام;
:الإخطار بالنتيجة;


##### 4.5.13.3. عدم وجود معالجة الأخطاء
❌ **غير صحيح:**
plantuml
:إرسال طلب;
:استلام الرد;
:عرض النتيجة;


✅ **صحيح:**
plantuml
:إرسال طلب;

if (الطلب ناجح؟) then (yes)
  :عرض النتيجة;
else (no)
  :عرض رسالة خطأ;
endif


##### 4.5.13.4. الاستخدام غير الصحيح للتزامن
❌ **غير صحيح:** (إجراءات متسلسلة كمتوازية)
plantuml
fork
  :المصادقة;
fork again
  :الحصول على بيانات الملف الشخصي;
end fork


✅ **صحيح:**
plantuml
:المصادقة;

fork
  :إرسال بريد إلكتروني ترحيبي;
fork again
  :تسجيل حدث التدقيق;
end fork

:إعادة التوجيه إلى الصفحة الرئيسية;


---

#### 4.5.14. العناصر الخاصة

##### 4.5.14.1. الملاحظات والتعليقات
plantuml
:تنفيذ عملية معقدة;
note right
  هذه العملية قد تستغرق
  حتى 30 ثانية
end note

:إجراء آخر;
note left: عملية سريعة


##### 4.5.14.2. العمليات الفرعية المرتبطة
plantuml
:بدء عملية الموافقة;
note right: انظر المخطط المنفصل "عملية الموافقة"

:انتظار نتيجة الموافقة;


##### 4.5.14.3. نقاط الدخول/الخروج
plantuml
// نقاط دخول متعددة
start
:الدخول العادي;
end

(*) --> :الدخول الطارئ;


##### 4.5.14.4. القيود الزمنية
plantuml
:إرسال طلب;
:انتظار الرد لمدة 30 ثانية;

if (تم استلام الرد في الوقت المحدد؟) then (yes)
  :معالجة الرد;
else (no)
  :معالجة timeout;
  stop
endif


---

#### 4.5.15. قائمة التحقق من الجودة

##### 4.5.15.1. التحقق الهيكلي:
- [ ] يبدأ المخطط بـ `@startuml` وينتهي بـ `@enduml`
- [ ] هناك نقطة `start` واحدة
- [ ] جميع المسارات تؤدي إلى `end`، `stop`، `kill` أو `detach`
- [ ] كل `if` له `endif` مقابلة
- [ ] كل `fork` له `end fork` أو `end merge` مقابلة
- [ ] كل `repeat` له `repeat while` مقابلة
- [ ] جميع swimlanes لها أسماء ذات معنى

##### 4.5.15.2. التحقق الدلالي:
- [ ] يغطي المخطط التدفق الرئيسي من Use Case
- [ ] التدفقات البديلة من Use Case ممثلة
- [ ] الأدوار في swimlanes تتوافق مع User Story
- [ ] كل إجراء يبدأ بفعل نشط
- [ ] تمت صياغة القرارات كأسئلة بخيارات إجابة واضحة
- [ ] توجد معالجة الأخطاء للعمليات الحرجة
- [ ] تم تحديد ونمذجة العمليات المتوازية بشكل صحيح

##### 4.5.15.3. فحص سهولة القراءة:
- [ ] عدد swimlanes: 2-6
- [ ] عمق تداخل الشروط: لا يزيد عن 3 مستويات
- [ ] طول الإجراء: 2-6 كلمات
- [ ] يمكن تمييز مجموعات الإجراءات المنطقية بصرياً
- [ ] يتناسب المخطط مع صفحة A4 واحدة

##### 4.5.15.4. فحص الامتثال للمتطلبات:
- [ ] جميع الخطوات من Use Case ممثلة
- [ ] تنعكس قواعد العمل في الشروط
- [ ] الأدوار والمسؤوليات منفصلة بوضوح
- [ ] نقاط اتخاذ القرار تتوافق مع منطق الأعمال
- [ ] نتيجة المخطط تحقق الهدف من User Story

##### 4.5.15.5. الفحص النهائي:
- [ ] يتم تجميع المخطط بدون أخطاء في PlantUML
- [ ] يعكس العنوان جوهر العملية
- [ ] يتوافق التصميم المرئي مع المعايير
- [ ] يمكن لأصحاب المصلحة فهم المخطط بدون تفسيرات إضافية

---

#### 4.5.16. أمثلة مخططات نموذجية

##### 4.5.16.1. عملية خطية بسيطة
plantuml
@startuml
title عملية تسجيل المستخدم

|المستخدم|
start
:ملء نموذج التسجيل;
:النقر على "تسجيل";

|النظام|
:الحصول على بيانات النموذج;
:التحقق من صحة البيانات;

if (البيانات صالحة؟) then (yes)
  :إنشاء حساب;
  :إرسال بريد تأكيد;
  
  |المستخدم|
  :استلام البريد الإلكتروني;
  :اتباع رابط التأكيد;
  
  |النظام|
  :تفعيل الحساب;
  :إعادة التوجيه إلى الصفحة الرئيسية;
  
  |المستخدم|
  :بدء العمل مع النظام;
  end
else (no)
  |المستخدم|
  :رؤية رسائل الخطأ;
  :تصحيح البيانات;
  stop
endif

@enduml


##### 4.5.16.2. عملية بمهام متوازية
plantuml
@startuml
title معالجة الطلب

|العميل|
start
:إضافة عناصر إلى السلة;
:المتابعة إلى الدفع;
:تحديد عنوان التسليم;
:اختيار طريقة الدفع;

|النظام|
fork
  :حساب تكلفة التسليم;
fork again
  :التحقق من توفر العناصر;
fork again
  :التحقق من صحة بيانات الدفع;
end merge

if (جميع الفحوصات ناجحة؟) then (yes)
  :إنشاء طلب;
  
  fork
    :حجز العناصر;
  fork again
    :إرسال إشعار إلى البائع;
  fork again
    :بدء عملية الدفع;
  end fork
  
  |العميل|
  :استلام تأكيد الطلب;
  end
else (no)
  :عرض الأخطاء;
  
  |العميل|
  :تصحيح بيانات الطلب;
  stop
endif

@enduml


هذه التعليمات تضمن إنشاء مخططات نشاط عالية الجودة تعكس بدقة عمليات العمل ويمكن قراءتها بسهولة من قبل جميع أصحاب المصلحة.

