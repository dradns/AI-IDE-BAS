### 4.5. Sequence диаграмма
**Инструкции по созданию Sequence диаграмм для ИИ агента**

#### 4.5.1. Содержание
1. [Основы и требования](#основы-и-требования)
2. [Структура диаграммы](#структура-диаграммы)
3. [Метрики качества](#метрики-качества)
4. [Валидационные правила](#валидационные-правила)
5. [Базовый шаблон](#базовый-шаблон)
6. [Типы взаимодействий](#типы-взаимодействий)
7. [Интеграция с артефактами](#интеграция-с-артефактами)
8. [Чек-лист качества](#чек-лист-качества)

---

#### 4.5.2. Основы и требования

##### 4.5.2.1. Обязательные входные артефакты:
- **User Story** - для понимания бизнес-сценария
- **Use Case** - для детального потока взаимодействий
- **Архитектурная диаграмма** - для участников и связей

##### 4.5.2.2. Дополнительные артефакты:
- API документация, техническая спецификация, диаграмма развертывания

---

#### 4.5.3. Структура диаграммы

##### 4.5.3.1. Заголовок и настройки
```plantuml
@startuml
autonumber "<b><color:DarkSlateBlue>.</color></b> " 
```

##### 4.5.3.2. Участники (строгая типизация)
```plantuml
actor User as "Роль из User Story"
participant Browser as "Browser"
participant "Web Server" as WebServer
participant "Application Server" as AppServer
participant "Database Server" as DBServer
```

##### 4.5.3.3. Группировка этапов
```plantuml
== Название логического этапа ==
```

##### 4.5.3.4. Взаимодействия с протоколами
```plantuml
User -> Browser : Бизнес-действие
Browser -> WebServer : HTTP GET/POST /endpoint
WebServer -> AppServer : REST API: метод
AppServer -> DBServer : JDBC: SELECT/INSERT
```

---

#### 4.5.4. Метрики качества

##### 4.5.4.1. Целевые показатели:
- **Покрытие участников**: 100% из архитектурной диаграммы
- **Логическая группировка**: 3-7 этапов с понятными названиями
- **Детализация протоколов**: 90% взаимодействий с указанием технологии
- **Обработка ошибок**: минимум 2 альтернативных сценария

##### 4.5.4.2. Система оценки:
- **Отличное качество**: ≥90% соответствие метрикам
- **Хорошее качество**: 70-89% соответствие метрикам
- **Требует доработки**: <70% соответствие метрикам

---

#### 4.5.5. Валидационные правила

##### 4.5.5.1. Автоматические проверки:
```
✓ Начинается с @startuml, заканчивается @enduml
✓ Роль актора соответствует User Story
✓ Участники присутствуют в архитектурной диаграмме
✓ Каждый этап имеет название в формате "== Название =="
✓ Протоколы указаны для технических взаимодействий
✓ Синхронные/асинхронные стрелки используются корректно
✓ Есть минимум 1 альтернативный поток (alt/opt/loop)
```

---

#### 4.5.6. Базовый шаблон

```plantuml
@startuml
autonumber "<b><color:DarkSlateBlue>.</color></b> " 

actor User as "[Роль из User Story]"
participant Browser as "Browser"
participant "Web Server" as WebServer
participant "Application Server" as AppServer
participant "Database Server" as DBServer

== Инициация действия ==
User -> Browser : [Бизнес-действие]
Browser -> WebServer : HTTP [метод] /[endpoint]

== Обработка запроса ==
WebServer -> AppServer : REST API: [метод]

== Работа с данными ==
AppServer -> DBServer : JDBC: [SQL операция]
DBServer --> AppServer : [Результат]

== Возврат результата ==
AppServer --> WebServer : JSON: [данные]
WebServer --> Browser : HTTP 200 OK
Browser --> User : [Отображение результата]

@enduml
```

---

#### 4.5.7. Типы взаимодействий

##### 4.5.7.1. Протоколы и синтаксис:
| Тип | Синтаксис | Пример |
|-----|-----------|--------|
| **HTTP** | `HTTP [метод] /endpoint` | `HTTP GET /api/users` |
| **REST API** | `REST API: [операция]` | `REST API: getUserData` |
| **База данных** | `JDBC: [SQL]` | `JDBC: SELECT * FROM users` |
| **Message Queue** | `MQ: [операция]` | `MQ: publish userCreated` |
| **gRPC** | `gRPC: [метод]` | `gRPC: GetUserProfile` |

##### 4.5.7.2. Типы стрелок:
- `->` и `-->` - синхронные вызовы/ответы
- `->>` и `-->>` - асинхронные вызовы/ответы
- `->` на себя - внутренняя обработка

##### 4.5.7.3. Управляющие конструкции:
```plantuml
alt Успешный сценарий
    // основной поток
else Ошибка
    // обработка ошибки
end

opt Условное выполнение
    // опциональные действия
end

loop Повторение
    // циклические действия
end
```

---

#### 4.5.8. Интеграция с артефактами

##### 4.5.8.1. Связь с User Story:
- **Актор диаграммы** = роль из US
- **Основной поток** = описание действий из US
- **Результат** = ожидаемая выгода из US

##### 4.5.8.2. Связь с Use Case:
- **Основной сценарий UC** = главная последовательность
- **Альтернативные потоки UC** = alt/opt блоки в диаграмме
- **Исключения UC** = error handling блоки

##### 4.5.8.3. Связь с архитектурой:
- **Участники sequence** = компоненты из архитектуры
- **Взаимодействия** = связи между компонентами
- **Протоколы** = технологии интеграции

---

#### 4.5.9. Стандартные этапы и названия

##### 4.5.9.1. Типовые группы:
1. **Инициация**: "Пользователь инициирует действие"
2. **Аутентификация**: "Проверка прав доступа"
3. **Валидация**: "Проверка входных данных"
4. **Обработка**: "Бизнес-логика и вычисления"
5. **Сохранение**: "Работа с базой данных"
6. **Уведомления**: "Отправка сообщений"
7. **Ответ**: "Возврат результата пользователю"

##### 4.5.9.2. Примеры конкретных названий:
- "== Загрузка списка заказов =="
- "== Проверка корректности платежных данных =="
- "== Формирование отчета по продажам =="

---

#### 4.5.10. Обработка ошибок

##### 4.5.10.1. Обязательные сценарии ошибок:
```plantuml
alt Успешное выполнение
    AppServer -> DBServer : SELECT query
    DBServer --> AppServer : Data returned
else Ошибка подключения к БД
    AppServer -> DBServer : SELECT query
    DBServer --> AppServer : Error: Connection timeout
    AppServer --> WebServer : HTTP 500 Internal Error
    WebServer --> Browser : Страница ошибки
else Ошибка валидации данных
    AppServer -> AppServer : Validate input
    AppServer --> WebServer : HTTP 400 Bad Request
    WebServer --> Browser : Сообщение об ошибке
end
```

---

#### 4.5.11. Чек-лист качества

##### 4.5.11.1. Структурная проверка:
- [ ] ✅ Файл начинается с `@startuml` и заканчивается `@enduml`
- [ ] ✅ Используется autonumber для нумерации шагов
- [ ] ✅ Актор соответствует роли из User Story
- [ ] ✅ Все участники есть в архитектурной диаграмме

##### 4.5.11.2. Логическая проверка:
- [ ] ✅ 3-7 логических этапов с понятными названиями
- [ ] ✅ Последовательность шагов соответствует Use Case
- [ ] ✅ Есть альтернативные потоки (alt/opt/loop)
- [ ] ✅ Обработка минимум 2 типов ошибок

##### 4.5.11.3. Техническая проверка:
- [ ] ✅ Протоколы указаны для всех технических вызовов
- [ ] ✅ HTTP методы и endpoints конкретизированы
- [ ] ✅ SQL операции детализированы
- [ ] ✅ Синхронные/асинхронные вызовы корректны

##### 4.5.11.4. Интеграционная проверка:
- [ ] 🔗 Соответствие основному сценарию Use Case
- [ ] 🔗 Покрытие всех акторов из архитектуры
- [ ] 🔗 Технические детали соответствуют API спецификации

**Цель**: Создавать Sequence диаграммы, готовые для технической реализации и тестирования.

---

#### 4.5.12. Рекомендации по стилю

##### 4.5.12.1. Именование:
- **Акторы**: конкретные бизнес-роли
- **Участники**: архитектурные компоненты
- **Сообщения**: бизнес-термины для пользователей, технические для систем

##### 4.5.12.2. Детализация:
- **Краткость**: сообщения до 50 символов
- **Ясность**: понятная терминология
- **Последовательность**: логический порядок вызовов
- **Группировка**: объединение связанных действий

##### 4.5.12.3. Примеры качественных описаний:
✅ "HTTP POST /api/orders - создание заказа"  
✅ "JDBC: INSERT INTO orders (user_id, total)"  
✅ "Отображение страницы подтверждения заказа"  

❌ "Делает запрос"  
❌ "Возвращает данные"  
❌ "Система обрабатывает" 